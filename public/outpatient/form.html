<form name="visitForm" class="form" novalidate ng-submit="submit(visitForm)" ng-cloak>

  <!-- TODO something like http://bootsnipp.com/snippets/featured/form-process-steps -->

  <fieldset ng-if="page === 1">
    <!-- TODO red text on white background instead of alert -->
    <div class="alert alert-danger alert-show-hide" ng-show="yellAtUser" translate>These fields are required</div>
    <conflict-message ng-show="conflictError"></conflict-message>

    <!-- Visit date -->
    <div class="form-group" ng-show="fields.visitDate.enabled" ng-class="{'has-error': isInvalid(visitForm.visitDate)}">
      <label for="entry-visit-date" translate>Visit date</label>

      <div class="input-group">
        <!-- TODO in angular-ui/bootstrap master they removed weeks -->
        <input id="entry-visit-date" name="visitDate" type="text" class="form-control" required
               ng-model="visit.visitDate" datepicker-popup show-weeks="false" is-open="datePopupsOpen.visitDate">

      <span class="input-group-btn">
        <button class="btn btn-default" type="button" ng-click="openDatePopup('visitDate', $event)">
          <span class="icon-calendar"></span>
        </button>
      </span>
      </div>
    </div>

    <!-- Visit type -->
    <div class="form-group" ng-show="fields.visitType.enabled">
      <label for="entry-visit-visitType" translate>Visit type</label>

      <select class="form-control select2-multiple" id="entry-visit-visitType" name="visitType" multiple ui-select2
              ng-model="visit.visitType">
        <option ng-repeat="(value, text) in fields.visitType.values" value="{{value}}">{{text}}</option>
      </select>

      <span ng-show="isInvalid(visitForm.visitType)" class="help-block" translate>Select visit type</span>
    </div>

    <!-- Symptom onset -->
    <div class="form-group" ng-show="fields.symptomOnsetDate.enabled"
         ng-class="{'has-error': isInvalid(visitForm.symptomOnsetDate)}">

      <label for="entry-visit-onset" translate>Symptom onset</label>

      <div class="input-group">
        <input id="entry-visit-onset" name="symptomOnsetDate" type="text" class="form-control"
               ng-model="visit.symptomOnsetDate" datepicker-popup show-weeks="false"
               is-open="datePopupsOpen.symptomOnsetDate">

      <span class="input-group-btn">
        <button class="btn btn-default" type="button" ng-click="openDatePopup('symptomOnsetDate', $event)">
          <span class="icon-calendar"></span>
        </button>
      </span>
      </div>
    </div>

    <!-- Facility -->
    <div class="form-group" ng-show="fields.facility.enabled">
      <label for="entry-visit-facility" translate>Facility</label>

      <select class="form-control" id="entry-visit-facility" name="facility" ng-model="visit.medicalFacility.name"
          ng-options="value as text for (value, text) in fields.facility.values">
        <option value=""></option>
      </select>
    </div>

  </fieldset>

  <!-- Patient info page -->
  <fieldset ng-if="page === 2">
    <!-- Patient ID -->
    <div class="form-group" ng-show="fields.patientID.enabled">
      <label for="entry-patient-id" translate>Patient ID</label>
      <input type="text" id="entry-patient-id" class="form-control" name="patientID" ng-model="visit.patient.id">
    </div>

    <!-- Name -->
    <div class="form-group" ng-show="fields.patientName.enabled">
      <label for="entry-patient-name" translate>Name</label>
      <!-- Don't impose ANY restricts on name, e.g. don't assume First name, Last name. Naming varies widely among
           cultures. It's best to just have a single name field. -->
      <input type="text" id="entry-patient-name" class="form-control" name="patientName" ng-model="visit.patient.name">
    </div>

    <!-- Sex -->
    <div class="form-group" ng-show="fields.patientSex.enabled">
      <label translate>Sex</label>
      <br> <!-- By default, Bootstrap puts the label on the same line as the inline radio controls -->
      <label class="radio-inline">
        <input type="radio" name="sex" value="male" ng-model="visit.patient.sex">
        <span translate>Male</span>
      </label>
      <label class="radio-inline">
        <input type="radio" name="sex" value="female" ng-model="visit.patient.sex">
        <span translate>Female</span>
      </label>
      <label class="radio-inline">
        <input type="radio" name="sex" value="" ng-model="visit.patient.sex">
        <span translate>Unknown</span>
      </label>
    </div>

    <!-- Age TODO allow entering date of birth or age -->
    <div class="form-group" ng-show="fields.patientAge.enabled"
         ng-class="{'has-error': isInvalid(visitForm.age), 'has-warning': visit.patient.age > 120}">
      <label for="entry-visit-age" translate>Age</label>

      <div class="input-group">
        <input class="form-control" id="entry-visit-age" name="age" ng-model="visit.patient.age" type="number"
               min="0" max="200" placeholder="{{agePlaceholder | translate}}">

        <span class="input-group-addon" translate>years</span>
      </div>

      <span ng-show="isInvalid(visitForm.age)" class="help-block" translate>
        Please enter a valid age in years, for example 15 or 0.5
      </span>
      <span ng-show="visit.patient.age > 120 && visit.patient.age != 999" class="help-block" translate>
        {{visit.patient.age}} years is quite old. Are you sure?
      </span>
      <span ng-show="visit.patient.age == 999" class="help-block" translate>
        Leave this field blank if you don't know the patient's age
      </span>
    </div>

    <!-- Telephone -->
    <div class="form-group" ng-show="fields.patientPhone.enabled"
         ng-class="{'has-error': isInvalid(visitForm.patientPhone)}">

      <label for="entry-patient-phone" translate>Telephone number</label>
      <!-- type="tel" doesn't actually enforce any syntax, but it will use the appropriate mobile keyboard and it's
           more semantically accurate -->
      <input type="tel" id="entry-patient-phone" class="form-control" name="patientPhone"
             ng-model="visit.patient.phone">
    </div>

    <!-- Address -->
    <div class="form-group" ng-show="fields.patientAddress.enabled"
         ng-class="{'has-error': isInvalid(visitForm.patientAddress)}">

      <label for="entry-patient-address" translate>Address</label>
      <!-- Addresses are way too complicated to try and impose any kind of semantics on them besides free text. This
           is more for followup in case a patient needs to be manually contacted anyway, so un-semanticness is fine. -->
      <textarea id="entry-patient-address" class="form-control" name="patientAddress" ng-model="visit.patient.address">
      </textarea>
    </div>
  </fieldset>

  <!-- Patient vitals -->
  <fieldset ng-if="page === 3">

    <!-- Temperature -->
    <div class="form-group" ng-show="fields.temperature.enabled"
         ng-class="{'has-error': isInvalid(visitForm.temperature)}">

      <label for="entry-temperature" translate>Temperature</label>
      <div class="input-group">
        <input type="number" id="entry-temperature" class="form-control" name="temperature"
               ng-model="visit.patient.temperature">
        <span class="input-group-addon" translate>Â°C</span>
      </div>
    </div>

    <!-- Pulse -->
    <div class="form-group" ng-show="fields.pulse.enabled"
         ng-class="{'has-error': isInvalid(visitForm.pulse)}">

      <label for="entry-pulse" translate>Pulse</label>
      <div class="input-group">
        <input type="number" id="entry-pulse" class="form-control" name="pulse" ng-model="visit.patient.pulse">
        <span class="input-group-addon" translate>BPM</span>
      </div>
    </div>

    <!-- Weight -->
    <div class="form-group" ng-show="fields.weight.enabled" ng-class="{'has-error': isInvalid(visitForm.weight)}">
      <label for="entry-weight" translate>Weight</label>
      <div class="input-group">
        <input type="number" id="entry-weight" class="form-control" name="weight" ng-model="visit.patient.weight">
        <span class="input-group-addon" translate>kg</span>
      </div>
    </div>

    <!-- Blood pressure is too annoying since it's 2 separate--but related--inputs, each with a label and unit -->

    <!-- Pre-existing conditions. These are just diagnoses the patient already has, but some sites use different
         possible values than what gets stuck in diagnoses. -->
    <div class="form-group" ng-show="fields.preExistingConditions.enabled"
         ng-class="{'has-error': isInvalid(visitForm.preExistingConditions)}">

      <label for="entry-pre-existing-conditions" translate>Pre-existing conditions</label>
      <select class="form-control select2-multiple" id="entry-pre-existing-conditions" name="preExistingConditions"
              multiple ui-select2 ng-model="visit.patient.preExistingConditions">
        <option ng-repeat="(value, text) in fields.preExistingConditions.values" value="{{value}}">{{text}}</option>
      </select>
    </div>

  </fieldset>

  <!-- Specimen -->
  <fieldset ng-if="page === 4">
    <specimen-inputs fields="fields" ng-model="visit.specimen"></specimen-inputs>

    <antiviral-inputs fields="fields" ng-model="visit.antiviral"></antiviral-inputs>
  </fieldset>

  <fieldset ng-if="page === 'last'">
    <!-- need this message for validation -->
    <div class="alert alert-danger alert-show-hide" ng-show="yellAtUser" translate>These fields are required</div>

    <!-- Symptoms -->
    <div class="form-group" ng-show="fields.symptoms.enabled">
      <label for="entry-visit-symptoms" translate>Symptoms</label>

      <select class="form-control select2-multiple" id="entry-visit-symptoms" multiple ui-select2
              ng-model="visit.symptoms">
        <option ng-repeat="(value, text) in fields.symptoms.values" value="{{value}}">{{text}}</option>
      </select>

      <span ng-show="isInvalid(visitForm.symptoms)" class="help-block" translate>Select symptom(s)</span>
    </div>

    <!-- Diagnoses -->
    <div class="form-group" ng-show="fields.diagnoses.enabled">
      <label for="entry-visit-diagnoses" translate>Diagnoses</label>

      <select class="form-control select2-multiple" id="entry-visit-diagnoses" name="diagnoses" multiple ui-select2
              ng-model="visit.diagnoses">
        <option ng-repeat="(value, text) in fields.diagnoses.values" value="{{value}}">{{text}}</option>
      </select>

      <span ng-show="isInvalid(visitForm.diagnoses)" class="help-block" translate>Select diagnoses</span>
    </div>

    <!-- Disposition -->
    <div class="form-group" ng-show="fields.disposition.enabled">
      <label for="entry-visit-disposition" translate>Disposition</label>

      <select class="form-control select2-multiple" id="entry-visit-disposition" name="disposition" multiple ui-select2
              ng-model="visit.disposition">
        <option ng-repeat="(value, text) in fields.disposition.values" value="{{value}}">{{text}}</option>
      </select>

      <span ng-show="isInvalid(visitForm.disposition)" class="help-block" translate>Select a disposition type</span>
    </div>

    <!-- Notes -->
    <div class="form-group" ng-show="fields.notes.enabled">
      <label for="entry-visit-notes" translate>Notes</label>

      <textarea class="form-control" id="entry-visit-notes" name="Notes"
                ng-model="visit.notes"></textarea>
      <span class="help-block" translate>Anything else you want to add</span>
    </div>
  </fieldset>

  <div ng-transclude></div>

</form>
